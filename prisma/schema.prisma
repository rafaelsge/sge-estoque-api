datasource db {
  provider = "mysql" // ou postgresql, conforme seu setup
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum status_atendimento {
  aberto
  em_atendimento
  finalizado
}

enum direcao_mensagem {
  entrada
  saida
}

model loja {
  id       Int       @id @default(autoincrement())
  codigo   Int       @unique
  nome     String
  cidade   String
  usuarios usuario[]
  produtos produto[]
}

model usuario {
  id         Int      @id @default(autoincrement())
  codigo     Int      // c√≥digo do ERP
  nome       String
  email      String?
  telefone   String?
  senha_md5  String?
  cod_loja   Int
  loja       loja     @relation(fields: [cod_loja], references: [codigo])
  tokens     tokenrecuperacao[]
}

model produto {
  id             Int      @id @default(autoincrement())
  codigo         Int
  nome           String
  unidade_medida String
  codigo_barras  String?
  cod_loja       Int
  pr_venda       Decimal? @db.Decimal(12,2) @default(0.00)
  pr_custo       Decimal? @db.Decimal(12,2) @default(0.00)
  loja           loja     @relation(fields: [cod_loja], references: [codigo])
  eans           ean[]
  validades      produto_validade[]

  @@unique([cod_loja, codigo])
}

model ean {
  id           Int      @id @default(autoincrement())
  cod_loja     Int
  cod_produto  Int
  codigo_barras String
  produto      produto  @relation(fields: [cod_loja, cod_produto], references: [cod_loja, codigo])
}

model contagem {
  id           Int      @id @default(autoincrement())
  cod_loja     Int
  cod_usuario  Int
  cod_produto  Int
  qtde         Float
  sincronizado Boolean  @default(false)
  lote         String?          // <-- NOVO CAMPO
  updated_at     DateTime @updatedAt
  created_at     DateTime @default(now())
}

model produto_validade {
  id          Int      @id @default(autoincrement())
  cod_produto Int
  cod_loja    Int
  vencimento  DateTime @db.Date
  ativo       Int      @default(1)

  produto     produto  @relation(fields: [cod_loja, cod_produto], references: [cod_loja, codigo])

  @@map("produto_validade")
}
  
model tokenrecuperacao {
  id          Int      @id @default(autoincrement())
  id_usuario  Int
  token       String   @unique
  expira_em   DateTime
  usuario     usuario  @relation(fields: [id_usuario], references: [id])
}

model configuracao {
  id       Int     @id @default(autoincrement())
  codigo   Int
  cod_loja Int?
  nome     String?
  valor    String?
}

model cliente {
  id            Int      @id @default(autoincrement())
  cod_loja      Int
  codigo        Int?
  nome          String
  fantasia      String?
  tipo          String?  @db.VarChar(20)
  cpf_cnpj      String?  @db.VarChar(50)
  ie            String?  @db.VarChar(50)
  endereco      String?
  numero        String?  @db.VarChar(20)
  bairro        String?  @db.VarChar(100)
  cep           String?  @db.VarChar(20)
  cod_municipio Int?
  municipio     String?  @db.VarChar(120)
  complemento   String?  @db.VarChar(120)
  telefone      String?  @db.VarChar(30)
  email         String?
  ativo         Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([cod_loja, codigo])
  @@index([cod_loja, nome])
}

model condicao_pagamento {
  id         Int      @id @default(autoincrement())
  cod_loja   Int
  codigo     Int?
  nome       String
  prazo_dias Int?
  ativo      Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([cod_loja, codigo])
  @@index([cod_loja, nome])
}

model estoque {
  id          Int      @id @default(autoincrement())
  cod_loja    Int
  cod_produto Int
  quantidade  Decimal  @db.Decimal(12,3) @default(0.000)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@unique([cod_loja, cod_produto])
  @@index([cod_loja])
}

model pedido {
  id                 Int          @id @default(autoincrement())
  cod_loja           Int
  cod_usuario        Int?
  cod_cliente        Int?
  tipo               String?      @db.VarChar(50)
  cod_cond_pagto     Int?
  valor_frete        Decimal?     @db.Decimal(12,2) @default(0.00)
  nome_transportadora String?     @db.VarChar(120)
  tipo_frete         String?      @db.VarChar(30)
  total_itens        Int?
  total_pedido       Decimal      @db.Decimal(12,2)
  observacao         String?      @db.VarChar(500)
  origem             String?      @db.VarChar(100)
  status             Int          @default(0)
  data_hora          DateTime     @default(now())
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt
  itens              pedido_item[]

  @@index([cod_loja, data_hora])
}

model pedido_item {
  id            Int      @id @default(autoincrement())
  id_pedido     Int
  cod_produto   Int
  descricao     String?  @db.VarChar(255)
  quantidade    Decimal  @db.Decimal(12,3)
  pr_venda      Decimal? @db.Decimal(12,2)
  pr_custo      Decimal? @db.Decimal(12,2)
  subtotal      Decimal? @db.Decimal(12,2)
  compl_item    String?  @db.VarChar(255)
  perc_desconto Decimal? @db.Decimal(5,2)
  vl_desconto   Decimal? @db.Decimal(12,2)
  created_at    DateTime @default(now())
  pedido        pedido   @relation(fields: [id_pedido], references: [id], onDelete: Cascade)

  @@index([id_pedido])
}

model contato {
  id            Int      @id @default(autoincrement())
  cod_loja      Int
  cliente_codigo Int?
  contato       String   @db.VarChar(100)
  telefone      String   @db.VarChar(50)
  tipo          String?  @db.VarChar(20)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  atendimentos  atendimento[]
  mensagens     mensagem[]

  @@unique([id, cod_loja])
  @@unique([cod_loja, telefone])
  @@index([cod_loja, cliente_codigo])
  @@map("contatos")
}

model atendimento {
  id            Int                @id @default(autoincrement())
  cod_loja      Int
  contato_id    Int
  cliente_codigo Int?
  usuario_id    Int?
  origem        String             @default("whatsapp") @db.VarChar(50)
  status        status_atendimento @default(aberto)
  aberto_em     DateTime           @default(now())
  iniciado_em   DateTime?
  finalizado_em DateTime?
  created_at    DateTime           @default(now())
  updated_at    DateTime           @updatedAt
  contato       contato            @relation(fields: [contato_id, cod_loja], references: [id, cod_loja], onDelete: Restrict)
  mensagens     mensagem[]

  @@unique([id, cod_loja])
  @@index([cod_loja, status])
  @@index([cod_loja, contato_id, status])
  @@index([cod_loja, usuario_id, status])
  @@map("atendimentos")
}

model mensagem {
  id            Int              @id @default(autoincrement())
  cod_loja      Int
  atendimento_id Int
  contato_id    Int
  usuario_id    Int?
  direcao       direcao_mensagem
  tipo          String           @default("texto") @db.VarChar(30)
  texto         String?          @db.LongText
  payload       Json?
  criado_em     DateTime         @default(now())
  atendimento   atendimento      @relation(fields: [atendimento_id, cod_loja], references: [id, cod_loja], onDelete: Cascade)
  contato       contato          @relation(fields: [contato_id, cod_loja], references: [id, cod_loja], onDelete: Restrict)

  @@index([cod_loja, atendimento_id])
  @@index([cod_loja, contato_id])
  @@index([cod_loja, criado_em])
  @@map("mensagens")
}

model pedido_restaurante {
  id            Int      @id @default(autoincrement())
  cod_loja      Int
  cod_usuario   Int
  codigo_cartao String?
  data_hora     DateTime
  origem        String?
  status        Int      @default(0)
  total_itens   Int
  total_pedido  Decimal  @db.Decimal(12,2)
  created_at    DateTime @default(now())
  itens         pedido_restaurante_item[]
}

model pedido_restaurante_item {
  id          Int     @id @default(autoincrement())
  pedido_id   Int
  cod_produto Int
  descricao   String
  quantidade  Decimal @db.Decimal(12,3)
  pr_venda    Decimal @db.Decimal(12,2)
  pr_custo    Decimal @db.Decimal(12,2)
  subtotal    Decimal @db.Decimal(12,2)

  pedido pedido_restaurante @relation(fields: [pedido_id], references: [id], onDelete: Cascade)
}
